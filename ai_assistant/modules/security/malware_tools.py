# security/malware_tools.py - phát hiện lệnh nguy hiểm trong mã nguồn

import ast

DANGEROUS_BUILTINS = {"eval", "exec", "compile", "open", "os.system", "subprocess", "input"}

def detect_malicious_code(filepath):
    """Phân tích mã nguồn Python và phát hiện đoạn mã nguy hiểm."""
    with open(filepath, "r", encoding="utf-8") as f:
        source = f.read()
    try:
        tree = ast.parse(source)
    except Exception as e:
        return f"❌ Không thể phân tích cú pháp: {e}"

    warnings = []
    for node in ast.walk(tree):
        if isinstance(node, ast.Call):
            func = getattr(node.func, 'id', None) or getattr(node.func, 'attr', None)
            if func and func in DANGEROUS_BUILTINS:
                warnings.append(f"⚠️ Phát hiện lệnh nguy hiểm: {func} tại dòng {node.lineno}")
    return "\n".join(warnings) if warnings else "✅ Không phát hiện mã độc"